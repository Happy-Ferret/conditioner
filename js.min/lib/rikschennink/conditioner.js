!function(e){var t=function(t,n,i,r,o,s){var a,u,l,d=function(e,t){this._path=e,this._expected=t,this._watches=[],this._count=0};d.prototype={getPath:function(){return this._path},getExpected:function(){return this._expected},isTrue:function(){for(var e=0,t=this._count;t>e;e++)if(!this._watches[e].valid)return!1;return!0},assignWatches:function(e){this._watches=e,this._count=e.length},toString:function(){return this._path+":{"+this._expected+"}"}};var h=function(e,t){this._expression=e,this._change=t,this._currentState=null};h.prototype={evaluate:function(){var e=this._expression.isTrue();e!=this._currentState&&(this._currentState=e,this._change(e))}};var c=function(){this._monitors=[],this._expressions=[]};c.prototype={_parse:function(e,t){if(this._expressions[e])return this._expressions[e];for(var n,i=0,r=e.split(","),o=r.length,s=[];o>i;i++)n=r[i].split(":"),s.push({test:n[0],value:t?n[0]:"undefined"==typeof n[1]?!0:n[1]});return this._expressions[e]=s,s},_mergeData:function(e,t,n){return s({element:n,expected:t},e)},create:function(e,t){var r=new i,o=e.getPath(),s=e.getExpected(),u=this;return a.loader.require([a.paths.monitors+o],function(e){var i,a,l,d,h,c,f,p,m=0,g=u._monitors[o];if(!g){if(g={watches:[],change:function(){for(m=0,i=g.watches.length;i>m;m++)g.watches[m].test()}},f=e.unique?u._mergeData(e.data,s,t):e.data,"function"==typeof e.trigger)e.trigger(g.change,f);else for(h in e.trigger)e.trigger.hasOwnProperty(h)&&e.trigger[h].addEventListener(h,g.change,!1);e.unique||(u._monitors[o]=g)}for(l=[],p="function"==typeof e.test,d=e.parse?e.parse(s,p):u._parse(s,p),i=d.length;i>m;m++)c=d[m],a={valid:null,data:e.unique?f:u._mergeData(e.data,c.value,t),test:function(e){if(!e)throw new Error('Conditioner: Test "'+c.test+'" not found on "'+o+'" Monitor.');return function(){var t=e(this.data);this.valid!=t&&(this.valid=t,n.publish(this,"change"))}}(p?e.test:e.test[c.test])},a.test(),l.push(a);g.watches=g.watches.concat(l),r.resolve(l)}),r}};var f={test:function(e,t,n){var i,r,o,s,a;for(i=g.parse(e),r=new h(i,n),o=0,s=i.getTests(),a=s.length;a>o;o++)this._setupMonitor(s[o],t,r)},_setupMonitor:function(e,t,i){var r,o=0;u.create(e,t).then(function(t){for(e.assignWatches(t),r=t.length;r>o;o++)n.subscribe(t[o],"change",function(){i.evaluate()});i.evaluate()})}},p=function(e,t){this._expression=e,this._negate="undefined"==typeof t?!1:t};p.prototype.isTrue=function(){return this._expression.isTrue()!==this._negate},p.prototype.getTests=function(){return this._expression instanceof d?[this._expression]:this._expression.getTests()},p.prototype.toString=function(){return(this._negate?"not ":"")+this._expression.toString()};var m=function(e,t,n){this._a=e,this._operator=t,this._b=n};m.prototype.isTrue=function(){return"and"===this._operator?this._a.isTrue()&&this._b.isTrue():this._a.isTrue()||this._b.isTrue()},m.prototype.getTests=function(){return this._a.getTests().concat(this._b.getTests())},m.prototype.toString=function(){return"("+this._a.toString()+" "+this._operator+" "+this._b.toString()+")"};var g={parse:function(e){var t,n,i,r,o,s,a,u,l,h,c,f=0,g="",_=[],v="",b=!1,y=!1,x=null,M=null,w=[],A=e.length;for(x||(x=_);A>f;f++)if(s=e.charCodeAt(f),123!==s)if(125===s&&(t=x.length-1,n=t+1,b="not"===x[t],n=b?t:t+1,r=new d(g,v),x[n]=new p(r,b),g="",v="",b=!1,y=!1),y)v+=e.charAt(f);else{if(40===s&&(x.push([]),w.push(x),x=x[x.length-1]),32===s||0===f||40===s){if(i=e.substr(f,5).match(/and |or |not /g),!i)continue;l=i[0],h=l.length-1,x.push(l.substring(0,h)),f+=h}if(41===s||f===A-1)do if(M=w.pop(),0!==x.length){for(o=0,c=x.length;c>o;o++)"string"==typeof x[o]&&("not"===x[o]?(x.splice(o,2,new p(x[o+1],!0)),o=-1,c=x.length):"not"!==x[o+1]&&(x.splice(o-1,3,new m(x[o-1],x[o],x[o+1])),o=-1,c=x.length));1===x.length&&M&&(M[M.length-1]=x[0],x=M)}else x=M;while(f===A-1&&M)}else for(y=!0,g="",a=f-2;a>=0&&(u=e.charCodeAt(a),32!==u&&40!==u);)g=e.charAt(a)+g,a--;return 1===_.length?_[0]:_}},_={init:function(e){e()},allowsActivation:function(){return!0},destroy:function(){}},v=function(e,t){"string"==typeof e&&e.length&&(this._conditions=e,this._element=t,this._state=!1)};v.prototype={init:function(e){var t=this,i=!1;f.test(this._conditions,this._element,function(r){t._state=r,n.publish(t,"change"),i||(i=!0,e())})},allowsActivation:function(){return this._state},destroy:function(){}};var b={_options:{},_redirects:{},registerModule:function(e,t,n){this._options[a.loader.toUrl(e)]=t,n&&(this._redirects[n]=e),a.loader.config(e,t)},getRedirect:function(e){return this._redirects[e]||e},getModule:function(e){if(!e)throw new Error('ModuleRegistry.getModule(path): "path" is a required parameter.');return this._options[e]||this._options[a.loader.toUrl(e)]}},y=function(e,t,n,i){if(!e||!t)throw new Error('ModuleController(path,element,options,agent): "path" and "element" are required parameters.');this._path=b.getRedirect(e),this._alias=e,this._element=t,this._options=n||{},this._agent=i||_,this._Module=null,this._module=null,this._initialized=!1,this._onAgentStateChangeBind=this._onAgentStateChange.bind(this);var r=this;this._agent.init(function(){r._initialize()})};y.prototype={hasInitialized:function(){return this._initialized},getModulePath:function(){return this._path},isModuleAvailable:function(){return this._agent.allowsActivation()&&!this._module},isModuleActive:function(){return null!==this._module},wrapsModuleWithPath:function(e){return this._path===e||this._alias===e},_initialize:function(){this._initialized=!0,n.subscribe(this._agent,"change",this._onAgentStateChangeBind),n.publishAsync(this,"init",this),this._agent.allowsActivation()&&this._onBecameAvailable()},_onBecameAvailable:function(){n.publishAsync(this,"available",this),this._load()},_onAgentStateChange:function(){var e=this._agent.allowsActivation();this._module&&!e?this._unload():!this._module&&e&&this._onBecameAvailable()},_load:function(){if(this._Module)return this._onLoad(),void 0;var e=this;a.loader.require([this._path],function(t){if(!t)throw new Error("ModuleController: A module needs to export an object.");e._Module=t,e._onLoad()})},_optionsToObject:function(e){if("string"==typeof e)try{return JSON.parse(e)}catch(t){throw new Error('ModuleController.load(): "options" is not a valid JSON string.')}return e},_parseOptions:function(e,t,n){var i,r,o=[],a={},u={};do i=b.getModule(e),o.push({page:i,module:t.options}),e=t.__superUrl;while(t=t.__super);for(r=o.length;r--;)a=s(a,o[r].page),u=s(u,o[r].module);return i=s(u,a),n&&(i=s(i,this._optionsToObject(n))),i},_onLoad:function(){if(this._agent.allowsActivation()){var e=this._parseOptions(this._path,this._Module,this._options);if("function"==typeof this._Module?this._module=new this._Module(this._element,e):(this._module=this._Module.load?this._Module.load(this._element,e):null,"undefined"==typeof this._module&&(this._module=this._Module)),!this._module)throw new Error('ModuleController.load(): could not initialize module, missing constructor or "load" method.');n.inform(this._module,this),n.publishAsync(this,"load",this)}},_unload:function(){return this._available=!1,this._module?(n.conceal(this._module,this),this._module.unload&&this._module.unload(),this._module=null,n.publishAsync(this,"unload",this),!0):!1},destroy:function(){this._unload(),n.unsubscribe(this._agent,"ready",this._onAgentReadyBind),n.unsubscribe(this._agent,"change",this._onAgentStateChangeBind),this._agent.destroy()},execute:function(e,t){if(!this._module)return{status:404,response:null};var n=this._module[e];if(!n)throw new Error('ModuleController.execute(method,params): function specified in "method" not found on module.');return t=t||[],{status:200,response:n.apply(this._module,t)}}};var x=function(){var e=function(e){return e.isModuleActive()},t=function(e){return e.isModuleAvailable()},i=function(e){return e.getModulePath()},s=function(e,t){if(!e)throw new Error('NodeController(element): "element" is a required parameter.');this._element=e,this._element.setAttribute(a.attr.processed,"true"),this._priority=t?parseInt(t,10):0,this._moduleControllers=[],this._moduleAvailableBind=this._onModuleAvailable.bind(this),this._moduleLoadBind=this._onModuleLoad.bind(this),this._moduleUnloadBind=this._onModuleUnload.bind(this)};return s.hasProcessed=function(e){return"true"===e.getAttribute(a.attr.processed)},s.prototype={load:function(){if(!arguments||!arguments.length)throw new Error("NodeController.load(controllers): Expects an array of module controllers as parameters.");this._moduleControllers=Array.prototype.slice.call(arguments,0);for(var e,t=0,i=this._moduleControllers.length;i>t;t++)e=this._moduleControllers[t],n.subscribe(e,"available",this._moduleAvailableBind),n.subscribe(e,"load",this._moduleLoadBind)},destroy:function(){for(var e=0,t=this._moduleControllers.length;t>e;e++)this._destroyModule(this._moduleControllers[e]);this._moduleControllers=[],this._updateAttribute(a.attr.initialized,this._moduleControllers),this._element.removeAttribute(a.attr.processed),this._element=null},_destroyModule:function(e){n.unsubscribe(e,"available",this._moduleAvailableBind),n.unsubscribe(e,"load",this._moduleLoadBind),n.unsubscribe(e,"unload",this._moduleUnloadBind),n.conceal(e,this),e.destroy()},getPriority:function(){return this._priority},getElement:function(){return this._element},matchesSelector:function(e,t){return t&&!r(t,this._element)?!1:o(this._element,e,t)},areAllModulesActive:function(){return this.getActiveModules().length===this._moduleControllers.length},getActiveModules:function(){return this._moduleControllers.filter(e)},getModule:function(e){return this._getModules(e,!0)},getModules:function(e){return this._getModules(e)},_getModules:function(e,t){if("undefined"==typeof e)return t?this._moduleControllers[0]:this._moduleControllers.concat();for(var n,i=0,r=this._moduleControllers.length,o=[];r>i;i++)if(n=this._moduleControllers[i],n.wrapsModuleWithPath(e)){if(t)return n;o.push(n)}return t?null:o},execute:function(e,t){return this._moduleControllers.map(function(n){return{controller:n,result:n.execute(e,t)}})},_onModuleAvailable:function(e){n.inform(e,this),this._updateAttribute(a.attr.loading,this._moduleControllers.filter(t))},_onModuleLoad:function(e){n.unsubscribe(e,"load",this._moduleLoadBind),n.subscribe(e,"unload",this._moduleUnloadBind),this._updateAttribute(a.attr.loading,this._moduleControllers.filter(t)),this._updateAttribute(a.attr.initialized,this.getActiveModules())},_onModuleUnload:function(e){n.subscribe(e,"load",this._moduleLoadBind),n.unsubscribe(e,"unload",this._moduleUnloadBind),n.conceal(e,this),this._updateAttribute(a.attr.initialized,this.getActiveModules())},_updateAttribute:function(e,t){var n=t.map(i);n.length?this._element.setAttribute(e,n.join(",")):this._element.removeAttribute(e)}},s}(),M=function(){if(!arguments||!arguments.length)throw new Error("SyncedControllerGroup(controllers): Expects an array of node controllers as parameters.");this._inSync=!1,this._controllers=1===arguments.length?arguments[0]:Array.prototype.slice.call(arguments,0),this._controllerLoadedBind=this._onLoad.bind(this),this._controllerUnloadedBind=this._onUnload.bind(this);for(var e,t=0,i=this._controllers.length;i>t;t++){if(e=this._controllers[t],!e)throw new Error("SyncedControllerGroup(controllers): Stumbled upon an undefined controller is undefined.");n.subscribe(e,"load",this._controllerLoadedBind),n.subscribe(e,"unload",this._controllerUnloadedBind)}this._test()};M.prototype={destroy:function(){for(var e,t=0,i=this._controllers.length;i>t;t++)e=this._controllers[t],n.unsubscribe(e,"load",this._controllerLoadedBind),n.unsubscribe(e,"unload",this._controllerUnloadedBind);this._controllers=[]},areAllModulesActive:function(){for(var e,t=0,n=this._controllers.length;n>t;t++)if(e=this._controllers[t],!this._isActiveController(e))return!1;return!0},_onLoad:function(){this._test()},_onUnload:function(){this._unload()},_isActiveController:function(e){return e.isModuleActive&&e.isModuleActive()||e.areAllModulesActive&&e.areAllModulesActive()},_test:function(){this.areAllModulesActive()&&this._load()},_load:function(){this._inSync||(this._inSync=!0,n.publishAsync(this,"load",this._controllers))},_unload:function(){this._inSync&&(this._inSync=!1,n.publish(this,"unload",this._controllers))}};var w=function(){this._nodes=[]};return w.prototype={parse:function(e){if(!e)throw new Error('ModuleLoader.loadModules(context): "context" is a required parameter.');var t,n,i=e.querySelectorAll("[data-module]"),r=i.length,o=0,s=[];if(!i)return[];for(;r>o;o++)n=i[o],x.hasProcessed(n)||s.push(new x(n,n.getAttribute(a.attr.priority)));for(s.sort(function(e,t){return e.getPriority()-t.getPriority()}),o=s.length;--o>=0;)t=s[o],t.load.apply(t,this._getModuleControllersByElement(t.getElement()));return this._nodes=this._nodes.concat(s),s},load:function(e,t){if(!t)return null;t=t.length?t:[t];var n,i,r=0,o=t.length,s=[];for(n=new x(e);o>r;r++)i=t[r],s.push(this._getModuleController(i.path,e,i.options,i.conditions));return n.load(s),this._nodes.push(n),n},getNodes:function(e,t,n){if("undefined"==typeof e&&"undefined"==typeof t)return n?this._nodes[0]:this._nodes.concat();for(var i,r=0,o=this._nodes.length,s=[];o>r;r++)if(i=this._nodes[r],i.matchesSelector(e,t)){if(n)return i;s.push(i)}return n?null:s},destroy:function(e){for(var t,n=e.length,i=0;n--;)t=this._nodes.indexOf(e[n]),-1!==t&&(this._nodes.splice(t,1),e[n].destroy(),i++);return e.length===i},_getModuleControllersByElement:function(e){var t,n,i,r=[],o=e.getAttribute(a.attr.module)||"",s=0;if(91===o.charCodeAt(0)){try{t=JSON.parse(o)}catch(u){throw new Error('ModuleLoader.load(context): "data-module" attribute contains a malformed JSON string.')}if(!t)return[];if(i=t.length,123===o.charCodeAt(1))for(;i>s;s++)n=t[s],r.push(this._getModuleController(n.path,e,n.options,n.conditions));else for(;i>s;s++)n=t[s],r.push(this._getModuleController(n[0],e,"string"==typeof n[1]?n[2]:n[1],"string"==typeof n[1]?n[1]:n[2]))}else o.length&&r.push(this._getModuleController(o,e,e.getAttribute(a.attr.options),e.getAttribute(a.attr.conditions)));return r},_getModuleController:function(e,t,n,i){return new y(e,t,n,i?new v(i,t):_)}},a={paths:{monitors:"./monitors/"},attr:{options:"data-options",module:"data-module",conditions:"data-conditions",priority:"data-priority",initialized:"data-initialized",processed:"data-processed",loading:"data-loading"},loader:{require:function(e,n){t(e,n)},config:function(e,t){var n={};n[e]=t,requirejs.config({config:n})},toUrl:function(e){return requirejs.toUrl(e)}},modules:{}},u=new c,l=new w,{init:function(t){return t&&this.setOptions(t),l.parse(e)},setOptions:function(e){if(!e)throw new Error('Conditioner.setOptions(options): "options" is a required parameter.');var t,n,i,r;a=s(a,e);for(n in a.paths)a.paths.hasOwnProperty(n)&&(a.paths[n]+="/"!==a.paths[n].slice(-1)?"/":"");for(n in a.modules)a.modules.hasOwnProperty(n)&&(i=a.modules[n],r="string"==typeof i?i:i.alias,t="string"==typeof i?null:i.options||{},b.registerModule(n,t,r))},parse:function(e){if(!e)throw new Error('Conditioner.parse(context): "context" is a required parameter.');return l.parse(e)},load:function(e,t){return l.load(e,t)},sync:function(){var e=Object.create(M.prototype);return M.apply(e,1!==arguments.length||arguments.slice?arguments:arguments[0]),e},getNode:function(e,t){return l.getNodes(e,t,!0)},getNodes:function(e,t){return l.getNodes(e,t,!1)},destroy:function(){var e=[],t=arguments[0];if(!t)throw new Error("Conditioner.destroy(...): A DOM node, Array, String or NodeController is required as the first argument.");return Array.isArray(t)&&(e=t),"string"==typeof t?e=l.getNodes(t,arguments[1]):t instanceof x?e.push(t):t.nodeName&&(e=l.getNodes().filter(function(e){return r(t,e.getElement())})),0===e.length?!1:l.destroy(e)},getModule:function(e,t,n){for(var i,r=0,o=this.getNodes(t,n),s=o.length;s>r;r++)if(i=o[r].getModule(e))return i;return null},getModules:function(e,t,n){for(var i,r=0,o=this.getNodes(t,n),s=o.length,a=[];s>r;r++)i=o[r].getModules(e),i.length&&(a=a.concat(i));return a},is:function(e,t){if(!e)throw new Error('Conditioner.is(condition,[element]): "condition" is a required parameter.');var n=new i;return f.test(e,t,function(e){n.resolve(e)}),n},on:function(e,t,n){if(!e)throw new Error('Conditioner.on(condition,[element],callback): "condition" and "callback" are required parameter.');n="function"==typeof t?t:n,f.test(e,t,function(e){n(e)})}}};if("undefined"!=typeof module&&module.exports)module.exports=t(require,require("./utils/Observer"),require("./utils/Promise"),require("./utils/contains"),require("./utils/matchesSelector"),require("./utils/mergeObjects"));else{if("function"!=typeof define||!define.amd)throw new Error("To use ConditionerJS you need to setup a module loader like RequireJS.");define(["require","./utils/Observer","./utils/Promise","./utils/contains","./utils/matchesSelector","./utils/mergeObjects"],t)}}(document);