// conditioner v1.0.0 - ConditionerJS - Frizz free, environment-aware, javascript modules.
// Copyright (c) 2014 Rik Schennink - http://conditionerjs.com
// License: MIT (http://www.opensource.org/licenses/mit-license.php)
!function(){"use strict";var a=function(a,b,c,d,e){var f=function(a,b){this._expression=a instanceof g||a instanceof f?a:null,this._config=this._expression?null:a,this._negate="undefined"==typeof b?!1:b};f.prototype.assignTester=function(a){this._expression=a},f.prototype.getConfig=function(){return this._config?[{expression:this,config:this._config}]:this._expression.getConfig()},f.prototype.succeeds=function(){return this._expression.succeeds?this._expression.succeeds()!==this._negate:!1},f.prototype.toString=function(){return(this._negate?"not ":"")+(this._expression?this._expression.toString():this._config.path+":{"+this._config.value+"}")};var g=function(a,b,c){this._a=a,this._operator=b,this._b=c};g.prototype.succeeds=function(){return"and"===this._operator?this._a.succeeds()&&this._b.succeeds():this._a.succeeds()||this._b.succeeds()},g.prototype.toString=function(){return"("+this._a.toString()+" "+this._operator+" "+this._b.toString()+")"},g.prototype.getConfig=function(){return[this._a.getConfig(),this._b.getConfig()]};var h={getExpressionsCount:function(a){return a.match(/(:\{)/g).length},fromString:function(a){var b,c,d,e,h,i,j,k,l,m,n=0,o="",p=[],q="",r=!1,s=!1,t=null,u=null,v=[],w=a.length;for(t||(t=p);w>n;n++)if(h=a.charCodeAt(n),123!==h)if(125===h&&(b=t.length-1,c=b+1,r="not"===t[b],c=r?b:b+1,t[c]=new f({path:o,value:q},r),o="",q="",r=!1,s=!1),s)q+=a.charAt(n);else{if(40===h&&(t.push([]),v.push(t),t=t[t.length-1]),32===h||0===n||40===h){if(d=a.substr(n,5).match(/and |or |not /g),!d)continue;k=d[0],l=k.length-1,t.push(k.substring(0,l)),n+=l}if(41===h||n===w-1)do if(u=v.pop(),0!==t.length){for(e=0,m=t.length;m>e;e++)"string"==typeof t[e]&&("not"===t[e]?(t.splice(e,2,new f(t[e+1],!0)),e=-1,m=t.length):"not"!==t[e+1]&&(t.splice(e-1,3,new g(t[e-1],t[e],t[e+1])),e=-1,m=t.length));1===t.length&&u&&(u[u.length-1]=t[0],t=u)}else t=u;while(n===w-1&&u)}else for(s=!0,o="",i=n-2;i>=0&&(j=a.charCodeAt(i),32!==j&&40!==j);)o=a.charAt(i)+o,i--;return 1===p.length?p[0]:p}},i={_tests:{},_createTest:function(a,c){if(!c.assert)throw new Error('TestRegister._addTest(path,config): "config.assert" is a required parameter.');var d=function(){};return d.supported="support"in c?c.support():!0,d._callbacks=[],d._ready=!1,d._setup=function(a){d.supported&&(d._callbacks.push(a.onchange.bind(a)),d._ready||(d._ready=!0,c.setup.call(d,d._measure)))},d._measure=function(a){var b="measure"in c?c.measure.call(d._measure,a):!0;if(b)for(var e=0,f=d._callbacks.length;f>e;e++)d._callbacks[e](a)},d.prototype.supported=function(){return d.supported},d.prototype.onchange=function(){b.publish(this,"change")},d.prototype.arrange=c.arrange?function(a,b){d.supported&&c.arrange.call(this,a,b)}:function(){d._setup(this)},c.measure&&(d.prototype.measure=c.measure),d.prototype.assert=c.assert,d},_findTest:function(a){return this._tests[a]},_storeTest:function(a,b){this._tests[a]=b},getTest:function(a,b){a="./tests/"+a,r.loader([a],function(c){var d=i._findTest(a);d||(d=i._createTest(a,c),i._storeTest(a,d)),b(new d)})}},j=function(a,c,d){this._test=a,this._expected=c,this._element=d,this._result=!1,this._changed=!0,this._onChangeBind=this._onChange.bind(this),b.subscribe(this._test,"change",this._onChangeBind),this._test.arrange(this._expected,this._element)};j.prototype={_onChange:function(){this._changed=!0},succeeds:function(){return this._changed&&(this._changed=!1,this._result=this._test.assert(this._expected,this._element)),this._result},destroy:function(){b.unsubscribe(this._test,"change",this._onChangeBind)}};var k={_options:{},_redirects:{},registerModule:function(a,b,c){this._options[r.loader.toUrl(a)]=b,c&&(this._redirects[c]=a),r.loader.config(a,b)},getRedirect:function(a){return this._redirects[a]||a},getModule:function(a){if(!a)throw new Error('ModuleRegistry.getModule(path): "path" is a required parameter.');return this._options[a]||this._options[r.loader.toUrl(a)]}},l=function(a,c,d,e){if(!a||!c)throw new Error('ModuleController(path,element,options,agent): "path" and "element" are required parameters.');this._path=k.getRedirect(a),this._alias=a,this._element=c,this._options=d||{},this._agent=e||o,this._Module=null,this._module=null,this._initialized=!1,this._onAgentReadyBind=this._onAgentReady.bind(this),this._onAgentStateChangeBind=this._onAgentStateChange.bind(this),this._agent.allowsActivation()?this._initialize():b.subscribe(this._agent,"ready",this._onAgentReadyBind)};l.prototype={hasInitialized:function(){return this._initialized},getModulePath:function(){return this._path},isModuleAvailable:function(){return this._agent.allowsActivation()&&!this._module},isModuleActive:function(){return null!==this._module},wrapsModuleWithPath:function(a){return this._path===a||this._alias===a},_onAgentReady:function(){this._initialize()},_initialize:function(){this._initialized=!0,b.subscribe(this._agent,"change",this._onAgentStateChangeBind),b.publishAsync(this,"init",this),this._agent.allowsActivation()&&this._onBecameAvailable()},_onBecameAvailable:function(){b.publishAsync(this,"available",this),this._load()},_onAgentStateChange:function(){var a=this._agent.allowsActivation();this._module&&!a?this._unload():!this._module&&a&&this._onBecameAvailable()},_load:function(){if(this._Module)return void this._onLoad();var a=this;r.loader.load([this._path],function(b){if(!b)throw new Error("ModuleController: A module needs to export an object.");a._Module=b,a._onLoad()})},_optionsToObject:function(a){if("string"==typeof a)try{return JSON.parse(a)}catch(b){throw new Error('ModuleController.load(): "options" is not a valid JSON string.')}return a},_parseOptions:function(a,b,c){var d,f,g=[],h={},i={};do d=k.getModule(a),g.push({page:d,module:b.options}),a=b.__superUrl;while(b=b.__super);for(f=g.length;f--;)h=e(h,g[f].page),i=e(i,g[f].module);return d=e(i,h),c&&(d=e(d,this._optionsToObject(c))),d},_onLoad:function(){if(this._agent.allowsActivation()){var a=this._parseOptions(this._path,this._Module,this._options);if("function"==typeof this._Module?this._module=new this._Module(this._element,a):(this._module=this._Module.load?this._Module.load(this._element,a):null,"undefined"==typeof this._module&&(this._module=this._Module)),!this._module)throw new Error('ModuleController.load(): could not initialize module, missing constructor or "load" method.');b.inform(this._module,this),b.publishAsync(this,"load",this)}},_unload:function(){return this._available=!1,this._module?(b.conceal(this._module,this),this._module.unload&&this._module.unload(),this._module=null,b.publishAsync(this,"unload",this),!0):!1},destroy:function(){this._unload(),b.unsubscribe(this._agent,"ready",this._onAgentReadyBind),b.unsubscribe(this._agent,"change",this._onAgentStateChangeBind),this._agent.destroy()},execute:function(a,b){if(!this._module)return{status:404,response:null};var c=this._module[a];if(!c)throw new Error('ModuleController.execute(method,params): function specified in "method" not found on module.');return b=b||[],{status:200,response:c.apply(this._module,b)}}};var m=function(){var a=function(a){return a.isModuleActive()},e=function(a){return a.isModuleAvailable()},f=function(a){return a.getModulePath()},g=function(a,b){if(!a)throw new Error('NodeController(element): "element" is a required parameter.');this._element=a,this._element.setAttribute(r.attr.processed,"true"),this._priority=b?parseInt(b,10):0,this._moduleControllers=[],this._moduleAvailableBind=this._onModuleAvailable.bind(this),this._moduleLoadBind=this._onModuleLoad.bind(this),this._moduleUnloadBind=this._onModuleUnload.bind(this)};return g.hasProcessed=function(a){return"true"===a.getAttribute(r.attr.processed)},g.prototype={load:function(){if(!arguments||!arguments.length)throw new Error("NodeController.load(controllers): Expects an array of module controllers as parameters.");this._moduleControllers=Array.prototype.slice.call(arguments,0);for(var a,c=0,d=this._moduleControllers.length;d>c;c++)a=this._moduleControllers[c],b.subscribe(a,"available",this._moduleAvailableBind),b.subscribe(a,"load",this._moduleLoadBind)},destroy:function(){for(var a=0,b=this._moduleControllers.length;b>a;a++)this._destroyModuleController(this._moduleControllers[a]);this._moduleControllers=[],this._updateAttribute(r.attr.initialized,this._moduleControllers),this._element.removeAttribute(r.attr.processed),this._element=null},_destroyModuleController:function(a){b.unsubscribe(a,"available",this._moduleAvailableBind),b.unsubscribe(a,"load",this._moduleLoadBind),b.unsubscribe(a,"unload",this._moduleUnloadBind),b.conceal(a,this),a.destroy()},getPriority:function(){return this._priority},getElement:function(){return this._element},matchesSelector:function(a,b){return b&&!c(b,this._element)?!1:d(this._element,a,b)},areAllModulesActive:function(){return this.getActiveModuleControllers().length===this._moduleControllers.length},getActiveModuleControllers:function(){return this._moduleControllers.filter(a)},getModuleController:function(a){return this._getModuleControllers(a,!0)},getModuleControllers:function(a){return this._getModuleControllers(a)},_getModuleControllers:function(a,b){if("undefined"==typeof a)return b?this._moduleControllers[0]:this._moduleControllers.concat();for(var c,d=0,e=this._moduleControllers.length,f=[];e>d;d++)if(c=this._moduleControllers[d],c.matchesPath(a)){if(b)return c;f.push(c)}return b?null:f},execute:function(a,b){return this._moduleControllers.map(function(c){return{controller:c,result:c.execute(a,b)}})},_onModuleAvailable:function(a){b.inform(a,this),this._updateAttribute(r.attr.loading,this._moduleControllers.filter(e))},_onModuleLoad:function(a){b.unsubscribe(a,"load",this._moduleLoadBind),b.subscribe(a,"unload",this._moduleUnloadBind),this._updateAttribute(r.attr.loading,this._moduleControllers.filter(e)),this._updateAttribute(r.attr.initialized,this.getActiveModuleControllers())},_onModuleUnload:function(a){b.subscribe(a,"load",this._moduleLoadBind),b.unsubscribe(a,"unload",this._moduleUnloadBind),b.conceal(a,this),this._updateAttribute(r.attr.initialized,this.getActiveModuleControllers())},_updateAttribute:function(a,b){var c=b.map(f);c.length?this._element.setAttribute(a,c.join(",")):this._element.removeAttribute(a)}},g}(),n=function(){if(!arguments||!arguments.length)throw new Error("SyncedControllerGroup(controllers): Expects an array of node controllers as parameters.");this._inSync=!1,this._controllers=Array.prototype.slice.call(arguments,0),this._controllerLoadedBind=this._onLoad.bind(this),this._controllerUnloadedBind=this._onUnload.bind(this);for(var a,c=0,d=this._controllers.length;d>c;c++)a=this._controllers[c],b.subscribe(a,"load",this._controllerLoadedBind),b.subscribe(a,"unload",this._controllerUnloadedBind);this._test()};n.prototype={destroy:function(){for(var a,c=0,d=this._controllers.length;d>c;c++)a=this._controllers[c],b.unsubscribe(a,"load",this._controllerLoadedBind),b.unsubscribe(a,"unload",this._controllerUnloadedBind);this._controllers=[]},_onLoad:function(){this._test()},_onUnload:function(){this._unload()},_isActiveController:function(a){return a.isModuleActive&&a.isModuleActive()||a.areModulesActive&&a.areModulesActive()},_test:function(){for(var a,b=0,c=this._controllers.length;c>b;b++)if(a=this._controllers[b],!this._isActiveController(a))return;this._load()},_load:function(){this._inSync||(this._inSync=!0,b.publishAsync(this,"load",this._controllers))},_unload:function(){this._inSync&&(this._inSync=!1,b.publish(this,"unload",this._controllers))}};var o={allowsActivation:function(){return!0},destroy:function(){}},p=function(a,b){"string"==typeof a&&a.length&&(this._suitable=!1,this._element=b,this._testers=[],this._onResultsChangedBind=this._onTestResultsChanged.bind(this),this._count=h.getExpressionsCount(a),this._expression=h.fromString(a),this._loadExpressionTests(this._expression.getConfig()))};p.prototype={allowsActivation:function(){return this._suitable},destroy:function(){for(var a=0,c=this._testers.length;c>a;a++)b.unsubscribe(this._testers[a],"change",this._onResultsChangedBind);this._testers=[],this._suitable=!1},_test:function(){var a=this._expression.succeeds();a!=this._suitable&&(this._suitable=a,b.publish(this,"change"))},_loadExpressionTests:function(a){for(var b=0,c=a.length;c>b;b++)Array.isArray(a[b])?this._loadExpressionTests(a[b]):this._loadTesterToExpression(a[b].config,a[b].expression)},_loadTesterToExpression:function(a,c){var d,e=this;i.getTest(a.path,function(f){d=new j(f,a.value,e._element),e._testers.push(d),c.assignTester(d),b.subscribe(f,"change",e._onResultsChangedBind),e._count--,0===e._count&&e._onReady()})},_onReady:function(){this._test(),b.publish(this,"ready")},_onTestResultsChanged:function(){this._test()}};var q=function(){this._nodes=[]};q.prototype={parse:function(a){if(!a)throw new Error('ModuleLoader.loadModules(context): "context" is a required parameter.');var b,c,d=a.querySelectorAll("[data-module]"),e=d.length,f=0,g=[];if(!d)return[];for(;e>f;f++)c=d[f],m.hasProcessed(c)||g.push(new m(c,c.getAttribute(r.attr.priority)));for(g.sort(function(a,b){return a.getPriority()-b.getPriority()}),f=g.length;--f>=0;)b=g[f],b.load.apply(b,this._getModuleControllersByElement(b.getElement()));return this._nodes=this._nodes.concat(g),g},load:function(a,b){if(!b)return null;b=b.length?b:[b];var c,d,e=0,f=b.length,g=[];for(c=new m(a);f>e;e++)d=b[e],g.push(this._getModuleController(d.path,a,d.options,d.conditions));return c.load(g),this._nodes.push(c),c},getNodes:function(a,b,c){if("undefined"==typeof a&&"undefined"==typeof b)return c?this._nodes[0]:this._nodes.concat();for(var d,e=0,f=this._nodes.length,g=[];f>e;e++)if(d=this._nodes[e],d.matchesSelector(a,b)){if(c)return d;g.push(d)}return c?null:g},_getModuleControllersByElement:function(a){var b,c,d,e=[],f=a.getAttribute(r.attr.module)||"",g=0,h=91===f.charCodeAt(0);if(h){try{b=JSON.parse(f)}catch(i){throw new Error('ModuleLoader.load(context): "data-module" attribute contains a malformed JSON string.')}if(!b)return[];for(d=b.length;d>g;g++)c=b[g],e.push(this._getModuleController(c.path,a,c.options,c.conditions))}else f.length&&e.push(this._getModuleController(f,a,a.getAttribute(r.attr.options),a.getAttribute(r.attr.conditions)));return e},_getModuleController:function(a,b,c,d){return new l(a,b,c,d?new p(d,b):o)}};var r={attr:{options:"data-options",module:"data-module",conditions:"data-conditions",priority:"data-priority",initialized:"data-initialized",processed:"data-processed",loading:"data-loading"},loader:{load:function(b,c){a(b,c)},config:function(a,b){var c={};c[a]=b,requirejs.config({config:c})},toUrl:function(a){return requirejs.toUrl(a)}},modules:{}},s=new q;return{init:function(a){a&&this.setOptions(a),s.parse(document)},setOptions:function(a){if(!a)throw new Error('ModuleLoader.setOptions(options): "options" is a required parameter.');var b,c,d,f;r=e(r,a);for(c in r.modules)r.modules.hasOwnProperty(c)&&(d=r.modules[c],f="string"==typeof d?d:d.alias,b="string"==typeof d?null:d.options||{},k.registerModule(c,b,f))},parse:function(a){return s.parse(a)},load:function(a,b){return s.load(a,b)},sync:function(){var a=Object.create(n.prototype);return n.apply(a,1!==arguments.length||arguments.slice?arguments:arguments[0]),a},getNode:function(a,b){return s.getNodes(a,b,!0)},getNodes:function(a,b){return s.getNodes(a,b,!1)}}};if("undefined"!=typeof module&&module.exports){var b=require("./utils/Observer"),c=require("./utils/contains"),d=require("./utils/matchesSelector"),e=require("./utils/mergeObjects");module.exports=a(require,b,c,d,e)}else{if("function"!=typeof define||!define.amd)throw new Error("Conditioner: To use conditioner you need to setup a module loader.");define(["require","./utils/Observer","./utils/contains","./utils/matchesSelector","./utils/mergeObjects"],a)}}();