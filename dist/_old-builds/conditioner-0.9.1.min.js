// conditioner v0.9.1 - ConditionerJS - Frizz free, environment-aware, javascript modules.
// Copyright (c) 2013 Rik Schennink - http://conditionerjs.com
// License: MIT (http://www.opensource.org/licenses/mit-license.php)
define("conditioner/Observer",{subscribe:function(t,e,i){t._subscriptions||(t._subscriptions=[]);for(var n,o=0,s=t._subscriptions;s>o;o++)if(n=t._subscriptions[o],n.type===e&&n.fn===i)return;t._subscriptions.push({type:e,fn:i})},unsubscribe:function(t,e,i){if(t._subscriptions)for(var n,o=t._subscriptions.length;--o>=0;)if(n=t._subscriptions[o],n.type===e&&n.fn===i){t._subscriptions.splice(o,1);break}},publish:function(t,e,i){t._subscriptions||(t._subscriptions=[]);for(var n,o=[],s=0,r=t._subscriptions.length;r>s;s++)n=t._subscriptions[s],n.type===e&&o.push(n);for(r=o.length,s=0;r>s;s++)o[s].fn(i);if(t._receivers)for(r=t._receivers.length,s=0;r>s;s++)this.publish(t._receivers[s],e,i)},inform:function(t,e){return t&&e?(t._receivers||(t._receivers=[]),t._receivers.push(e),!0):!1},conceal:function(t,e){if(!t||!e||!t._receivers)return!1;for(var i,n=t._receivers.length;--n>=0;)if(i=t._receivers[n],i===e)return t._receivers.splice(n,1),!0;return!1}}),define("conditioner/contains",[],function(){var t=document?document.body:null;return t&&t.compareDocumentPosition?function(t,e){return!!(16&t.compareDocumentPosition(e))}:t&&t.contains?function(t,e){return t!=e&&t.contains(e)}:function(t,e){for(var i=e.parentNode;i;){if(i===t)return!0;i=i.parentNode}return!1}}),define("conditioner/matchesSelector",[],function(){var t=null,e=document?document.body:null;return!e||e.matches?t="matches":e.webkitMatchesSelector?t="webkitMatchesSelector":e.mozMatchesSelector?t="mozMatchesSelector":e.msMatchesSelector?t="msMatchesSelector":e.oMatchesSelector&&(t="oMatchesSelector"),t?function(e,i){return e[t](i)}:function(t,e){for(var i=(t.parentNode||document).querySelectorAll(e)||[],n=i.length;n--;)if(i[n]==t)return!0;return!1}}),define("conditioner/mergeObjects",[],function(){var t=function(e,i){var n=Array.isArray(i),o=n&&[]||{};return i=i||{},n?(e=e||[],o=o.concat(e),i.forEach(function(i,n){"object"==typeof i?o[n]=t(e[n],i):-1===e.indexOf(i)&&o.push(i)})):(e&&"object"==typeof e&&Object.keys(e).forEach(function(t){o[t]=e[t]}),Object.keys(i).forEach(function(n){o[n]="object"==typeof i[n]&&i[n]?e[n]?t(e[n],i[n]):i[n]:i[n]})),o};return t}),define("conditioner",["require","conditioner/Observer","conditioner/contains","conditioner/matchesSelector","conditioner/mergeObjects"],function(t,e,i,n,o){var s=function(){};s.prototype={succeeds:function(){},getConfig:function(){}};var r=function(t,e){this._expression=t instanceof u||t instanceof r?t:null,this._config=this._expression?null:t,this._negate=e===void 0?!1:e};r.prototype=Object.create(s),r.prototype.assignTester=function(t){this._expression=t},r.prototype.getConfig=function(){return this._config?[{expression:this,config:this._config}]:this._expression.getConfig()},r.prototype.succeeds=function(){return this._expression.succeeds?this._expression.succeeds()!==this._negate:!1},r.prototype.toString=function(){return(this._negate?"not ":"")+(this._expression?""+this._expression:this._config.path+":{"+this._config.value+"}")};var u=function(t,e,i){this._a=t,this._operator=e,this._b=i};u.prototype=Object.create(s),u.prototype.succeeds=function(){return"and"===this._operator?this._a.succeeds()&&this._b.succeeds():this._a.succeeds()||this._b.succeeds()},u.prototype.toString=function(){return"("+(""+this._a)+" "+this._operator+" "+(""+this._b)+")"},u.prototype.getConfig=function(){return[this._a.getConfig(),this._b.getConfig()]};var l={getExpressionsCount:function(t){return t.match(/(:\{)/g).length},fromString:function(t){var e,i,n,o,s,l,a,c,h,d,_=0,f="",p=[],m="",g=!1,v=!1,b=null,M=null,C=[],y=t.length;for(b||(b=p);y>_;_++)if(s=t.charCodeAt(_),123!==s)if(125===s&&(e=b.length-1,i=e+1,g="not"===b[e],i=g?e:e+1,b[i]=new r({path:f,value:m},g),f="",m="",g=!1,v=!1),v)m+=t.charAt(_);else{if(40===s&&(b.push([]),C.push(b),b=b[b.length-1]),32===s||0===_||40===s){if(n=t.substr(_,5).match(/and |or |not /g),!n)continue;c=n[0],h=c.length-1,b.push(c.substring(0,h)),_+=h}if(41===s||_===y-1)do if(M=C.pop(),0!==b.length){for(o=0,d=b.length;d>o;o++)"string"==typeof b[o]&&("not"===b[o]?(b.splice(o,2,new r(b[o+1],!0)),o=-1,d=b.length):"not"!==b[o+1]&&(b.splice(o-1,3,new u(b[o-1],b[o],b[o+1])),o=-1,d=b.length));1===b.length&&M&&(M[M.length-1]=b[0],b=M)}else b=M;while(_===y-1&&M)}else for(v=!0,f="",l=_-2;l>=0&&(a=t.charCodeAt(l),32!==a&&40!==a);)f=t.charAt(l)+f,l--;return 1===p.length?p[0]:p}},a={_tests:{},_createTest:function(t,i){if(!i.assert)throw Error('TestRegister._addTest(path,config): "config.assert" is a required parameter.');var n=function(){};return n.supported="support"in i?i.support():!0,n._callbacks=[],n._ready=!1,n._setup=function(t){n.supported&&(n._callbacks.push(t.onchange.bind(t)),n._ready||(n._ready=!0,i.setup.call(n,n._measure)))},n._measure=function(t){var e="measure"in i?i.measure.call(n._measure,t):!0;if(e)for(var o=0,s=n._callbacks.length;s>o;o++)n._callbacks[o](t)},n.prototype.supported=function(){return n.supported},n.prototype.onchange=function(){e.publish(this,"change")},n.prototype.arrange=i.arrange?function(t,e){n.supported&&i.arrange.call(this,t,e)}:function(){n._setup(this)},i.measure&&(n.prototype.measure=i.measure),n.prototype.assert=i.assert,n},_findTest:function(t){return this._tests[t]},_storeTest:function(t,e){this._tests[t]=e},getTest:function(e,i){e="tests/"+e,t([e],function(t){var n=a._findTest(e);n||(n=a._createTest(e,t),a._storeTest(e,n)),i(new n)})}},c=function(t,i,n){this._test=t,this._expected=i,this._element=n,this._result=!1,this._changed=!0;var o=this;e.subscribe(this._test,"change",function(){o._changed=!0}),this._test.arrange(this._expected,this._element)};c.prototype.succeeds=function(){return this._changed&&(this._changed=!1,this._result=this._test.assert(this._expected,this._element)),this._result};var h={_modules:{},registerModule:function(t,e,i){var n,o,s=i||t;this._modules[s]={},e&&(this._modules[s].config=e,o={},o[t]=e,requirejs.config({config:o})),i&&(this._modules[s].alias=i,n={},n[i]=t,requirejs.config({map:{"*":n}}))},getModuleByPath:function(t){if(!t)throw Error('ModuleRegister.getModuleById(path): "path" is a required parameter.');return this._modules[t]}},d=function(t,e){this._suitable=!0,"string"==typeof t&&(this._suitable=!1,this._element=e,this._onResultsChangedBind=this._onTestResultsChanged.bind(this),this._count=l.getExpressionsCount(t),this._expression=l.fromString(t),this._loadExpressionTests(this._expression.getConfig()))};d.prototype={getSuitability:function(){return this._suitable},test:function(){var t=this._expression.succeeds();t!=this._suitable&&(this._suitable=t,e.publish(this,"change"))},_loadExpressionTests:function(t){for(var e=0,i=t.length;i>e;e++)Array.isArray(t[e])?this._loadExpressionTests(t[e]):this._loadTesterToExpression(t[e].config,t[e].expression)},_loadTesterToExpression:function(t,i){var n=this;a.getTest(t.path,function(o){i.assignTester(new c(o,t.value,n._element)),e.subscribe(o,"change",n._onResultsChangedBind),n._count--,0===n._count&&n._onReady()})},_onReady:function(){this.test(),e.publish(this,"ready",this._suitable)},_onTestResultsChanged:function(){this.test()}};var _=function(t,i,n){if(!t||!i)throw Error('ModuleController(path,element,options): "path" and "element" are required parameters.');this._path=t,this._element=i,this._options=n||{},this._Module=null,this._module=null,this._conditionsManager=new d(this._options.conditions,this._element),e.subscribe(this._conditionsManager,"ready",this._onInitialized.bind(this)),this._initialized=!this.isModuleConditioned()||this._conditionsManager.getSuitability(),this._available=!1};_.prototype={isModuleAvailable:function(){return this._available=this._conditionsManager.getSuitability(),this._available},isModuleActive:function(){return null!==this._module},isModuleConditioned:function(){return this._options.conditions!==void 0},hasInitialized:function(){return this._initialized},matchesPath:function(t){return this._path===t},_onInitialized:function(t){this._initialized=!0,e.subscribe(this._conditionsManager,"change",this._onConditionsChange.bind(this)),e.publish(this,"init",this),t&&this._onBecameAvailable()},_onBecameAvailable:function(){this._available=!0,e.publish(this,"available",this)},_onConditionsChange:function(){var t=this._conditionsManager.getSuitability();this._module&&!t&&this.unload(),!this._module&&t&&this._onBecameAvailable()},load:function(){if(this._Module)return this._onLoad(),void 0;var e=this;t([this._path],function(t){e._Module=t,e._onLoad()})},_onLoad:function(){if(this.isModuleAvailable()){var t,i=h.getModuleByPath(this._path),n=i?i.config:{},s={};if("string"==typeof this._options.options)try{s=JSON.parse(this._options.options)}catch(r){throw Error('ModuleController.load(): "options" is not a valid JSON string.')}else s=this._options.options;if(t=n?o(n,s):s,t=this._Module.options?o(this._Module.options,t):t,"function"==typeof this._Module?this._module=new this._Module(this._element,t):(this._module=this._Module.load?this._Module.load(this._element,t):null,this._module===void 0&&(this._module=this._Module)),!this._module)throw Error('ModuleController.load(): could not initialize module, missing constructor or "load" method.');this._element.setAttribute("data-initialized",this._path),e.inform(this._module,this),e.publish(this,"load",this)}},unload:function(){return this._available=!1,this._module?(e.conceal(this._module,this),this._module.unload&&this._module.unload(),this._element.removeAttribute("data-initialized"),this._module=null,e.publish(this,"unload",this),!0):!1},execute:function(t,e){if(!this._module)return{status:404,response:null};var i=this._module[t];if(!i)throw Error('ModuleController.execute(method,params): function specified in "method" not found on module.');return e=e||[],{status:200,response:i.apply(this._module,e)}}};var f=function(t){if(!t)throw Error('NodeController(element): "element" is a required parameter.');this._element=t,this._element.setAttribute("data-processed","true");var e=this._element.getAttribute("data-priority");this._priority=e?parseInt(e,10):0,this._moduleControllers=[],this._activeModuleController=null,this._activeModuleUnloadBind=this._onActiveModuleUnload.bind(this)};f.hasProcessed=function(t){return"true"===t.getAttribute("data-processed")},f.prototype={init:function(t){if(!t||!t.length)throw Error("NodeController.init(controllers): Expects an array of module controllers as parameters.");this._moduleControllers=t;for(var i,n=0,o=this._moduleControllers.length;o>n;n++)i=this._moduleControllers[n],i.hasInitialized()?this._onModuleInitialized():e.subscribe(i,"init",this._onModuleInitialized.bind(this))},getPriority:function(){return this._priority},getElement:function(){return this._element},matchesSelector:function(t,e){return e&&!i(e,this._element)?!1:n(this._element,t,e)},hasLoadedModule:function(){return this._activeModuleController?this._activeModuleController.isModuleActive():!1},getActiveModuleController:function(){return this._activeModuleController},getModuleController:function(t){return this._getModuleControllers(t,!0)},getModuleControllers:function(t){return this._getModuleControllers(t)},_getModuleControllers:function(t,e){if(t===void 0)return e?this._moduleControllers[0]:this._moduleControllers.concat();for(var i,n=0,o=this._moduleControllers.length,s=[];o>n;n++)if(i=this._moduleControllers[n],i.matchesPath(t)){if(e)return i;s.push(i)}return e?null:s},execute:function(t,e){return this._activeModuleController?this._activeModuleController.execute(t,e):{status:404,response:null}},_onModuleInitialized:function(){for(var t=this._moduleControllers.length;--t>=0;)if(!this._moduleControllers[t].hasInitialized())return;this._onModulesInitialized()},_onModulesInitialized:function(){var t=this._getSuitableActiveModuleController();t&&this._setActiveModuleController(t);for(var i=0,n=this._moduleControllers.length;n>i;i++)e.subscribe(this._moduleControllers[i],"available",this._onModuleAvailable.bind(this))},_onModuleAvailable:function(t){for(var e,i=0,n=this._moduleControllers.length;n>i;i++)if(e=this._moduleControllers[i],e!==t&&e.isModuleAvailable()&&e.isModuleConditioned())return;this._setActiveModuleController(t)},_setActiveModuleController:function(t){t!==this._activeModuleController&&(this._cleanActiveModuleController(),this._activeModuleController=t,e.subscribe(this._activeModuleController,"unload",this._activeModuleUnloadBind),e.inform(this._activeModuleController,this),this._activeModuleController.load())},_cleanActiveModuleController:function(){this._activeModuleController&&(e.unsubscribe(this._activeModuleController,"unload",this._activeModuleUnloadBind),e.conceal(this._activeModuleController,this),this._activeModuleController.unload(),this._activeModuleController=null)},_onActiveModuleUnload:function(){this._cleanActiveModuleController();var t=this._getSuitableActiveModuleController();t&&this._setActiveModuleController(t)},_getSuitableActiveModuleController:function(){for(var t,e=0,i=this._moduleControllers.length;i>e;e++)if(t=this._moduleControllers[e],t.isModuleAvailable())return t;return null}};var p=function(){this._options={modules:{}},this._nodes=[]};return p.prototype={init:function(t){t&&this.setOptions(t),this.parse(document)},setOptions:function(t){if(!t)throw Error('ModuleLoader.setOptions(options): "options" is a required parameter.');this._options=o(this._options,t);var e,i,n,s;for(i in this._options.modules)this._options.modules.hasOwnProperty(i)&&(n=this._options.modules[i],s="string"==typeof n?n:n.alias,e="string"==typeof n?null:n.options||{},h.registerModule(i,e,s))},parse:function(t){if(!t)throw Error('ModuleLoader.loadModules(context): "context" is a required parameter.');var e,i=t.querySelectorAll("[data-module]"),n=i.length,o=0,s=[];if(!i)return[];for(;n>o;o++)e=i[o],f.hasProcessed(e)||s.push(new f(e));for(s.sort(function(t,e){return t.getPriority()-e.getPriority()}),o=s.length;--o>=0;)s[o].init(this._getModuleControllersByElement(s[o].getElement()));return this._nodes=this._nodes.concat(s),s},load:function(t,e){if(!e)return null;e=e.length?e:[e];var i,n,o=0,s=e.length,r=[];for(i=new f(t);s>o;o++)n=e[o],r.push(new _(n.path,t,{conditions:n.conditions,options:n.options}));return i.init(r),this._nodes.push(i),i},getNode:function(t,e){return this._getNodes(t,e,!0)},getNodes:function(t,e){return this._getNodes(t,e)},_getNodes:function(t,e,i){if(t===void 0&&e===void 0)return i?this._nodes[0]:this._nodes.concat();for(var n,o=0,s=this._nodes.length,r=[];s>o;o++)if(n=this._nodes[o],n.matchesSelector(t,e)){if(i)return n;r.push(n)}return i?null:r},_getModuleControllersByElement:function(t){var e=[],i=t.getAttribute("data-module")||"",n=91===i.charCodeAt(0);if(n){var o;try{o=JSON.parse(i)}catch(s){throw Error('ModuleLoader.load(context): "data-module" attribute contains a malformed JSON string.')}if(!o)return[];for(var r,u=o.length,l=0;u>l;l++)r=o[l],e.push(new _(r.path,t,{conditions:r.conditions,options:r.options}))}else i.length&&e.push(new _(i,t,{conditions:t.getAttribute("data-conditions"),options:t.getAttribute("data-options")}));return e}},new p});