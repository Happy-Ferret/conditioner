!function(){"use strict";var t=function(t,e,n,o,i,r){var s=function(t,e){this._path=t,this._expected=e,this._watches=[],this._count=0};s.prototype={getPath:function(){return this._path},getExpected:function(){return this._expected},isTrue:function(){for(var t=0,e=this._count;e>t;t++)if(!this._watches[t].valid)return!1;return!0},assignWatches:function(t){this._watches=t,this._count=this._watches.length},toString:function(){return this._path+":{"+this._expected+"}"}};var l=function(t,e){this._expression=t,this._change=e,this._currentState=!1};l.prototype={evaluate:function(){var t=this._expression.isTrue();t!=this._currentState&&(this._currentState=t,this._change(t))}};var u={test:function(t,e,n){var o,i,r,s,u;for(o=c.parse(t),i=new l(o,n),r=0,s=o.getTests(),u=s.length;u>r;r++)this._setupMonitor(s[r],e,i)},_setupMonitor:function(t,n,o){var i,r=0;a.getInstance().create(t,n).then(function(n){for(console.log("create->then",(new Date).getTime()),i=n.length;i>r;r++)t.assignWatches(n[r]),e.subscribe(n[r],"change",function(){o.evaluate()});o.evaluate()})}},a=function(){var t=function(){this._monitors=[],this._expressions=[]};t.prototype={parse:function(t){if(this._expressions[t])return this._expressions[t];for(var e,n=0,o=t.split(","),i=o.length,r=[];i>n;n++)e=o[n].split(":"),r.push({test:e[0],value:"undefined"==typeof e[1]?!0:e[1]});return this._expressions[t]=r,r},create:function(t,e){var o=new n,i=t.getPath(),s=t.getExpected(),l=this;return y.loader.load(["./monitors/"+i],function(t){var n,u,a,d,h,c=0,_=l._monitors[i];if(!_){if(_={watches:[],change:function(){for(c=0,n=_.watches.length;n>c;c++)_.watches[c].test()}},"function"==typeof t.trigger)t.trigger(_.change,_.data);else for(h in t.trigger)t.trigger.hasOwnProperty(h)&&t.trigger[h].addEventListener(h,_.change,!1);t.unique||(l._monitors[i]=_)}for(a=[],d=_.parse?_.parse(s):l.parse(s),n=d.length;n>c;c++)u={valid:!1,data:r(t.data,{element:e,expected:"function"==typeof t.test?d[c].test:d[c].value}),test:function(t){return function(){this.valid=t(this.data)}}("function"==typeof t.test?t.test:t.test[d[c].test])},u.test(),a.push(u);_.watches=_.watches.concat(a),o.resolve(a)}),o}};var e;return{getInstance:function(){return e||(e=new t),e}}}(),d=function(t,e){this._expression=t,this._negate="undefined"==typeof e?!1:e};d.prototype.isTrue=function(){return this._expression.isTrue()!==this._negate},d.prototype.getTests=function(){return this._expression instanceof s?[this._expression]:this._expression.getTests()},d.prototype.toString=function(){return(this._negate?"not ":"")+this._expression.toString()};var h=function(t,e,n){this._a=t,this._operator=e,this._b=n};h.prototype.isTrue=function(){return"and"===this._operator?this._a.isTrue()&&this._b.isTrue():this._a.isTrue()||this._b.isTrue()},h.prototype.getTests=function(){return this._a.getTests().concat(this._b.getTests())},h.prototype.toString=function(){return"("+this._a.toString()+" "+this._operator+" "+this._b.toString()+")"};var c={parse:function(t){var e,n,o,i,r,l,u,a,c,_,f,p=0,g="",m=[],v="",b=!1,y=!1,A=null,w=null,M=[],C=t.length;for(A||(A=m);C>p;p++)if(l=t.charCodeAt(p),123!==l)if(125===l&&(e=A.length-1,n=e+1,b="not"===A[e],n=b?e:e+1,i=new s(g,v),A[n]=new d(i,b),g="",v="",b=!1,y=!1),y)v+=t.charAt(p);else{if(40===l&&(A.push([]),M.push(A),A=A[A.length-1]),32===l||0===p||40===l){if(o=t.substr(p,5).match(/and |or |not /g),!o)continue;c=o[0],_=c.length-1,A.push(c.substring(0,_)),p+=_}if(41===l||p===C-1)do if(w=M.pop(),0!==A.length){for(r=0,f=A.length;f>r;r++)"string"==typeof A[r]&&("not"===A[r]?(A.splice(r,2,new d(A[r+1],!0)),r=-1,f=A.length):"not"!==A[r+1]&&(A.splice(r-1,3,new h(A[r-1],A[r],A[r+1])),r=-1,f=A.length));1===A.length&&w&&(w[w.length-1]=A[0],A=w)}else A=w;while(p===C-1&&w)}else for(y=!0,g="",u=p-2;u>=0&&(a=t.charCodeAt(u),32!==a&&40!==a);)g=t.charAt(u)+g,u--;return 1===m.length?m[0]:m}},_={_options:{},_redirects:{},registerModule:function(t,e,n){this._options[y.loader.toUrl(t)]=e,n&&(this._redirects[n]=t),y.loader.config(t,e)},getRedirect:function(t){return this._redirects[t]||t},getModule:function(t){if(!t)throw new Error('ModuleRegistry.getModule(path): "path" is a required parameter.');return this._options[t]||this._options[y.loader.toUrl(t)]}},f=function(t,n,o,i){if(!t||!n)throw new Error('ModuleController(path,element,options,agent): "path" and "element" are required parameters.');this._path=_.getRedirect(t),this._alias=t,this._element=n,this._options=o||{},this._agent=i||m,this._Module=null,this._module=null,this._initialized=!1,this._onAgentReadyBind=this._onAgentReady.bind(this),this._onAgentStateChangeBind=this._onAgentStateChange.bind(this),this._agent.allowsActivation()?this._initialize():e.subscribe(this._agent,"ready",this._onAgentReadyBind)};f.prototype={hasInitialized:function(){return this._initialized},getModulePath:function(){return this._path},isModuleAvailable:function(){return this._agent.allowsActivation()&&!this._module},isModuleActive:function(){return null!==this._module},wrapsModuleWithPath:function(t){return this._path===t||this._alias===t},_onAgentReady:function(){this._initialize()},_initialize:function(){this._initialized=!0,e.subscribe(this._agent,"change",this._onAgentStateChangeBind),e.publishAsync(this,"init",this),this._agent.allowsActivation()&&this._onBecameAvailable()},_onBecameAvailable:function(){e.publishAsync(this,"available",this),this._load()},_onAgentStateChange:function(){var t=this._agent.allowsActivation();this._module&&!t?this._unload():!this._module&&t&&this._onBecameAvailable()},_load:function(){if(this._Module)return void this._onLoad();var t=this;y.loader.load([this._path],function(e){if(!e)throw new Error("ModuleController: A module needs to export an object.");t._Module=e,t._onLoad()})},_optionsToObject:function(t){if("string"==typeof t)try{return JSON.parse(t)}catch(e){throw new Error('ModuleController.load(): "options" is not a valid JSON string.')}return t},_parseOptions:function(t,e,n){var o,i,s=[],l={},u={};do o=_.getModule(t),s.push({page:o,module:e.options}),t=e.__superUrl;while(e=e.__super);for(i=s.length;i--;)l=r(l,s[i].page),u=r(u,s[i].module);return o=r(u,l),n&&(o=r(o,this._optionsToObject(n))),o},_onLoad:function(){if(this._agent.allowsActivation()){var t=this._parseOptions(this._path,this._Module,this._options);if("function"==typeof this._Module?this._module=new this._Module(this._element,t):(this._module=this._Module.load?this._Module.load(this._element,t):null,"undefined"==typeof this._module&&(this._module=this._Module)),!this._module)throw new Error('ModuleController.load(): could not initialize module, missing constructor or "load" method.');e.inform(this._module,this),e.publishAsync(this,"load",this)}},_unload:function(){return this._available=!1,this._module?(e.conceal(this._module,this),this._module.unload&&this._module.unload(),this._module=null,e.publishAsync(this,"unload",this),!0):!1},destroy:function(){this._unload(),e.unsubscribe(this._agent,"ready",this._onAgentReadyBind),e.unsubscribe(this._agent,"change",this._onAgentStateChangeBind),this._agent.destroy()},execute:function(t,e){if(!this._module)return{status:404,response:null};var n=this._module[t];if(!n)throw new Error('ModuleController.execute(method,params): function specified in "method" not found on module.');return e=e||[],{status:200,response:n.apply(this._module,e)}}};var p=function(){var t=function(t){return t.isModuleActive()},n=function(t){return t.isModuleAvailable()},r=function(t){return t.getModulePath()},s=function(t,e){if(!t)throw new Error('NodeController(element): "element" is a required parameter.');this._element=t,this._element.setAttribute(y.attr.processed,"true"),this._priority=e?parseInt(e,10):0,this._moduleControllers=[],this._moduleAvailableBind=this._onModuleAvailable.bind(this),this._moduleLoadBind=this._onModuleLoad.bind(this),this._moduleUnloadBind=this._onModuleUnload.bind(this)};return s.hasProcessed=function(t){return"true"===t.getAttribute(y.attr.processed)},s.prototype={load:function(){if(!arguments||!arguments.length)throw new Error("NodeController.load(controllers): Expects an array of module controllers as parameters.");this._moduleControllers=Array.prototype.slice.call(arguments,0);for(var t,n=0,o=this._moduleControllers.length;o>n;n++)t=this._moduleControllers[n],e.subscribe(t,"available",this._moduleAvailableBind),e.subscribe(t,"load",this._moduleLoadBind)},destroy:function(){for(var t=0,e=this._moduleControllers.length;e>t;t++)this._destroyModule(this._moduleControllers[t]);this._moduleControllers=[],this._updateAttribute(y.attr.initialized,this._moduleControllers),this._element.removeAttribute(y.attr.processed),this._element=null},_destroyModule:function(t){e.unsubscribe(t,"available",this._moduleAvailableBind),e.unsubscribe(t,"load",this._moduleLoadBind),e.unsubscribe(t,"unload",this._moduleUnloadBind),e.conceal(t,this),t.destroy()},getPriority:function(){return this._priority},getElement:function(){return this._element},matchesSelector:function(t,e){return e&&!o(e,this._element)?!1:i(this._element,t,e)},areAllModulesActive:function(){return this.getActiveModules().length===this._moduleControllers.length},getActiveModules:function(){return this._moduleControllers.filter(t)},getModule:function(t){return this._getModules(t,!0)},getModules:function(t){return this._getModules(t)},_getModules:function(t,e){if("undefined"==typeof t)return e?this._moduleControllers[0]:this._moduleControllers.concat();for(var n,o=0,i=this._moduleControllers.length,r=[];i>o;o++)if(n=this._moduleControllers[o],n.wrapsModuleWithPath(t)){if(e)return n;r.push(n)}return e?null:r},execute:function(t,e){return this._moduleControllers.map(function(n){return{controller:n,result:n.execute(t,e)}})},_onModuleAvailable:function(t){e.inform(t,this),this._updateAttribute(y.attr.loading,this._moduleControllers.filter(n))},_onModuleLoad:function(t){e.unsubscribe(t,"load",this._moduleLoadBind),e.subscribe(t,"unload",this._moduleUnloadBind),this._updateAttribute(y.attr.loading,this._moduleControllers.filter(n)),this._updateAttribute(y.attr.initialized,this.getActiveModules())},_onModuleUnload:function(t){e.subscribe(t,"load",this._moduleLoadBind),e.unsubscribe(t,"unload",this._moduleUnloadBind),e.conceal(t,this),this._updateAttribute(y.attr.initialized,this.getActiveModules())},_updateAttribute:function(t,e){var n=e.map(r);n.length?this._element.setAttribute(t,n.join(",")):this._element.removeAttribute(t)}},s}(),g=function(){if(!arguments||!arguments.length)throw new Error("SyncedControllerGroup(controllers): Expects an array of node controllers as parameters.");this._inSync=!1,this._controllers=1===arguments.length?arguments[0]:Array.prototype.slice.call(arguments,0),this._controllerLoadedBind=this._onLoad.bind(this),this._controllerUnloadedBind=this._onUnload.bind(this);for(var t,n=0,o=this._controllers.length;o>n;n++){if(t=this._controllers[n],!t)throw new Error("SyncedControllerGroup(controllers): Stumbled upon an undefined controller is undefined.");e.subscribe(t,"load",this._controllerLoadedBind),e.subscribe(t,"unload",this._controllerUnloadedBind)}this._test()};g.prototype={destroy:function(){for(var t,n=0,o=this._controllers.length;o>n;n++)t=this._controllers[n],e.unsubscribe(t,"load",this._controllerLoadedBind),e.unsubscribe(t,"unload",this._controllerUnloadedBind);this._controllers=[]},areAllModulesActive:function(){for(var t,e=0,n=this._controllers.length;n>e;e++)if(t=this._controllers[e],!this._isActiveController(t))return!1;return!0},_onLoad:function(){this._test()},_onUnload:function(){this._unload()},_isActiveController:function(t){return t.isModuleActive&&t.isModuleActive()||t.areAllModulesActive&&t.areAllModulesActive()},_test:function(){this.areAllModulesActive()&&this._load()},_load:function(){this._inSync||(this._inSync=!0,e.publishAsync(this,"load",this._controllers))},_unload:function(){this._inSync&&(this._inSync=!1,e.publish(this,"unload",this._controllers))}};var m={allowsActivation:function(){return!0},destroy:function(){}},v=function(t,n){if("string"==typeof t&&t.length){var o=this;this._state=!1,u.test(t,n,function(t){o._state=t,e.publish(o,"change")})}};v.prototype={allowsActivation:function(){return this._state},destroy:function(){}};var b=function(){this._nodes=[]};b.prototype={parse:function(t){if(!t)throw new Error('ModuleLoader.loadModules(context): "context" is a required parameter.');var e,n,o=t.querySelectorAll("[data-module]"),i=o.length,r=0,s=[];if(!o)return[];for(;i>r;r++)n=o[r],p.hasProcessed(n)||s.push(new p(n,n.getAttribute(y.attr.priority)));for(s.sort(function(t,e){return t.getPriority()-e.getPriority()}),r=s.length;--r>=0;)e=s[r],e.load.apply(e,this._getModuleControllersByElement(e.getElement()));return this._nodes=this._nodes.concat(s),s},load:function(t,e){if(!e)return null;e=e.length?e:[e];var n,o,i=0,r=e.length,s=[];for(n=new p(t);r>i;i++)o=e[i],s.push(this._getModuleController(o.path,t,o.options,o.conditions));return n.load(s),this._nodes.push(n),n},destroyNode:function(t){for(var e=this._nodes.length;e--;)if(this._nodes[e]===t)return this._nodes.splice(e,1),t.destroy(),!0;return!1},getNodes:function(t,e,n){if("undefined"==typeof t&&"undefined"==typeof e)return n?this._nodes[0]:this._nodes.concat();for(var o,i=0,r=this._nodes.length,s=[];r>i;i++)if(o=this._nodes[i],o.matchesSelector(t,e)){if(n)return o;s.push(o)}return n?null:s},_getModuleControllersByElement:function(t){var e,n,o,i=[],r=t.getAttribute(y.attr.module)||"",s=0,l=91===r.charCodeAt(0);if(l){try{e=JSON.parse(r)}catch(u){throw new Error('ModuleLoader.load(context): "data-module" attribute contains a malformed JSON string.')}if(!e)return[];for(o=e.length;o>s;s++)n=e[s],i.push(this._getModuleController(n.path,t,n.options,n.conditions))}else r.length&&i.push(this._getModuleController(r,t,t.getAttribute(y.attr.options),t.getAttribute(y.attr.conditions)));return i},_getModuleController:function(t,e,n,o){return new f(t,e,n,o?new v(o,e):m)}};var y={attr:{options:"data-options",module:"data-module",conditions:"data-conditions",priority:"data-priority",initialized:"data-initialized",processed:"data-processed",loading:"data-loading"},loader:{load:function(e,n){t(e,n)},config:function(t,e){var n={};n[t]=e,requirejs.config({config:n})},toUrl:function(t){return requirejs.toUrl(t)}},modules:{}},A=new b;return{init:function(t){return t&&this.setOptions(t),A.parse(document)},setOptions:function(t){if(!t)throw new Error('Conditioner.setOptions(options): "options" is a required parameter.');var e,n,o,i;y=r(y,t);for(n in y.modules)y.modules.hasOwnProperty(n)&&(o=y.modules[n],i="string"==typeof o?o:o.alias,e="string"==typeof o?null:o.options||{},_.registerModule(n,e,i))},parse:function(t){if(!t)throw new Error('Conditioner.parse(context): "context" is a required parameter.');return A.parse(t)},load:function(t,e){return A.load(t,e)},sync:function(){var t=Object.create(g.prototype);return g.apply(t,1!==arguments.length||arguments.slice?arguments:arguments[0]),t},getNode:function(t,e){return A.getNodes(t,e,!0)},getNodes:function(t,e){return A.getNodes(t,e,!1)},destroyNode:function(t){return A.destroyNode(t)},getModule:function(t,e,n){for(var o,i=0,r=this.getNodes(e,n),s=r.length;s>i;i++)if(o=r[i].getModule(t))return o;return null},getModules:function(t,e,n){for(var o,i=0,r=this.getNodes(e,n),s=r.length,l=[];s>i;i++)o=r[i].getModules(t),o.length&&(l=l.concat(o));return l},test:function(t,e){if(!t)throw new Error('Conditioner.test(conditions): "conditions" is a required parameter.');var o=new n;return u.test(t,e,function(e){console.log(t,e),o[e?"resolve":"reject"]()}),o}}};if("undefined"!=typeof module&&module.exports)module.exports=t(require,require("./utils/Observer"),require("./utils/Promise"),require("./utils/contains"),require("./utils/matchesSelector"),require("./utils/mergeObjects"));else{if("function"!=typeof define||!define.amd)throw new Error("To use ConditionerJS you need to setup a module loader like RequireJS.");define(["require","./utils/Observer","./utils/Promise","./utils/contains","./utils/matchesSelector","./utils/mergeObjects"],t)}}();